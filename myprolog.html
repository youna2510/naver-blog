<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="prolog.css">
    <title>SG Blog</title>
    <style>
        .user-profilepicture {
            width:135px;
        }

        .buttons {
            padding-top:20px;
        }

        #neighbor-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* í•œ ì¤„ì— 3ëª… */
        gap: 5px; /* ê°„ê²© ì¡°ì • */
        padding: 5px;
        }

    .neighbor-item {
        text-align: center;
        width: 50px; /* ë„ˆë¹„ ê³ ì • */
    }

    .neighbor-img {
        width: 40px;
        height: 40px;
        border-radius: 5px;
        border: 1px solid gray;
        overflow: hidden;
    }

    .neighbor-img img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* ì´ë¯¸ì§€ ê½‰ ì°¨ê²Œ */
        display: block;
    }

    .neighbor-nickname {
        display: block;
        font-size: 10px; /* ê¸€ì í¬ê¸° ì¤„ì´ê¸° */
        margin-top: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }


    </style>

    <script>
        function popup(){
            var url = "./neighbor_request.html";
            var name = "_blank";
            var option = "width = 480, height = 300, top = 100, left = 200, location = no"
            window.open(url, name, option);
        }



    </script>
</head>
<body>
    <div class="top_menubar">
        <a style="margin-left:50px;">ì´ì›ƒ ë¸”ë¡œê·¸</a>
        <a style="color: gray;"> | </a>
        <a style="color:black; text-decoration-line: none;" href="./main_login.html">ë¸”ë¡œê·¸ í™ˆ</a>
        <a style="color: gray;"> | </a>
        <a href="./main.html" class="login_btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <div id="top-area">
        <div id="blog-title">
        <table role="presentation">
            <tbody>
                <tr>
                    <td id="blogTitleText">
                        <h1><a id="blog-title-anchor" >
                            <span id="blogTitleName" class="itemtitlefont">ë¸”ë¡œê·¸ ì œëª©</span>
                        </a></h1>
                    </td>
                </tr>
            </tbody>
        </table>
        </div>
        
        <div id="blog-menu">
            <div class="border">
                    <table>
                        <tbody><tr><td nowrap="nowrap" class="menu1">
                            <ul>
                                <li>                        
                                    <a style="color:#861f1c; font-weight: bold;">í”„ë¡¤ë¡œê·¸</a>
                                </li>
                                <li> | </li>
                                <li>                       
                                    <a href="./myblog.html" style="color : black; text-decoration-line: none;">ë¸”ë¡œê·¸</a>
                                </li>      
                            </ul>
                        </td></tr></tbody>
                    </table>
            </div>
        </div>
        <hr style="margin-left: 140px;">
    </div>

    
<!--í”„ë¡œí•„-->
<div class="bg-body"> 
    <div class="con"> 
        <p class="image"> 
            <a href="#" >
                <img class="user-profilepicture" src="assets/profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
            </a> 
        </p> 
    </div> 
    <div class="name align"> 
        <div class="user-nickname"> <strong class="itemfont col" id="nickNameArea">ì‚¬ìš©ìë³¸ì¸</strong>
                <br> <span class="itemfont col">
                    <span class="blog_domain col"> </span> </span> 
                
            </div> 
        </div> <p class="caption align"> 
            <span class="itemfont_col">í”„ë¡œí•„ ì†Œê°œ</span>
            </p>
                <p class="more align"> <span class="m1">
        </p> 
        <div class="buttons">
            <button class="write" onclick="location.href='write.html'">ê¸€ì“°ê¸°</button>
            <button class="settings" onclick="location.href='profile.html'">í”„ë¡œí•„ ê´€ë¦¬</button>
        </div>
            
    </div> 
</div>

<!--ì„œë¡œì´ì›ƒ-->
<div class="bg-neighbor"> 
    <div class="neighbor-profile">
        <div class="user-nickname" style="font-size: 15px;"><strong></strong></div>
        <div>ì´ì›ƒ ì»¤ë„¥íŠ¸</div>
    </div>
    <div class="neighbor-list">
        <div class="all_neighborhood">
            <span>ì „ì²´ ì´ì›ƒ</span>
            <span id="neighbor-count" style="margin-left: 10px; color: green;">0</span><span>ëª…</span>
            <hr style="width:95%; border: 0.25px solid gray;">
        </div>
        <div id="neighbor-container" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;"></div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="pagination" style="text-align: center; margin-top: 10px;">
            <span id="page-indicator">1 / 1</span>
            <button id="prev-page" style="background: none; border: none; cursor: pointer;">â—€</button>
            <button id="next-page" style="background: none; border: none; cursor: pointer;">â–¶</button>
        </div>

        <hr style="width:80%; border: 0.25px solid gray;">
        <a id="neighbor-new-posts" href="main_login.html" style="margin-left:10px; font-size: 13px; color:gray;"></a>
    </div>
</div>




<div class="pro_posts">
    <!-- âœ… JSê°€ ë™ì ìœ¼ë¡œ ê²Œì‹œë¬¼ì„ ì‚½ì…í•  ì˜ˆì • -->
</div>


<script>
document.addEventListener("DOMContentLoaded", async function () {
                const accessToken = localStorage.getItem("access_token");
                if (!accessToken) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "login.html";
                    return;
                }
            
                try {
                    const response = await fetch("http://127.0.0.1:8000/profile/me/", {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json"
                        }
                    });
            
                    if (response.status === 200) {
                        const data = await response.json();
                        const nickname = data.username || "ìµëª…"; // ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
                        const profilePic = data.user_pic || "assets/profile.png"; // í”„ë¡œí•„ ì‚¬ì§„ ê°€ì ¸ì˜¤ê¸°\
                        const blogname = data.blog_name || "ë¸”ë¡œê·¸ ì œëª©";
                        const intro = data.intro || "í”„ë¡œí•„ ì†Œê°œê¸€";
            
                        // ğŸ”¥ ë‹‰ë„¤ì„ ë³€ê²½
                        document.querySelectorAll(".user-nickname").forEach(el => {
                            el.innerText = nickname;
                        });
            
                        // ğŸ”¥ í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½
                        document.querySelectorAll(".user-profilepicture").forEach(img => {
                            img.src = profilePic;
                        });

                        document.querySelectorAll(".itemtitlefont").forEach(e2 => {
                            e2.innerText = blogname;
                        });

                        document.querySelectorAll(".itemfont_col").forEach(e3 => {
                            e3.innerText = intro;
                        });
            
                    } else {
                        alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        console.log("âŒ ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);
                    }
                } catch (error) {
                    console.error("âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜:", error);
                    alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });



            document.addEventListener("DOMContentLoaded", async function () {
    try {
        // âœ… í˜„ì¬ í”„ë¡œí•„ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ë¸”ë¡œê·¸ ì£¼ì¸ì˜ `urlname`ì„ ì–»ê¸°
        const profileResponse = await fetch("http://127.0.0.1:8000/profile/me/", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("access_token")}`,
                "Content-Type": "application/json"
            }
        });

        if (!profileResponse.ok) {
            console.error("âŒ í”„ë¡œí•„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", profileResponse.status);
            return;
        }

        const profileData = await profileResponse.json();
        const urlname = profileData.urlname; // âœ… `urlname` ì‚¬ìš©

        if (!urlname) {
            console.error("âŒ urlnameì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
            return;
        }

        const apiUrl = `http://127.0.0.1:8000/posts/${urlname}/current/`;

        // âœ… ê²Œì‹œë¬¼ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(apiUrl, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        });

        if (!response.ok) {
            console.error("âŒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", response.status);
            return;
        }

        const posts = await response.json();
        const postContainer = document.querySelector(".pro_posts"); // âœ… ê²Œì‹œë¬¼ì„ ë‹´ì„ ì»¨í…Œì´ë„ˆ
        postContainer.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°

        if (posts.length === 0) {
            postContainer.innerHTML = "<p>ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }

        let postHtml = "";

        // âœ… 1, 2ë²ˆ (ì™¼ìª½ í° ê³µê°„)
        if (posts.length >= 1) {
            postHtml += createBigPost(posts[0], 1); // ì²« ë²ˆì§¸ ê²Œì‹œë¬¼
        }
        if (posts.length >= 2) {
            postHtml += createBigPost(posts[1], 2); // ë‘ ë²ˆì§¸ ê²Œì‹œë¬¼
        }

        // âœ… 3, 4, 5ë²ˆ (ì˜¤ë¥¸ìª½ ì‘ì€ ê³µê°„)
        if (posts.length > 2) {
            postHtml += `<div class="pro_sy2">`;
            for (let i = 2; i < posts.length; i++) {
                postHtml += createSmallPost(posts[i], i + 1); // 3, 4, 5ë²ˆì§¸ ê²Œì‹œë¬¼
            }
            postHtml += `</div>`;
        }

        postContainer.innerHTML = postHtml;

        // âœ… ê²Œì‹œë¬¼ í´ë¦­ ì´ë²¤íŠ¸ (ì´ë¯¸ ì •í•´ì§„ `n`ê°’ìœ¼ë¡œ ì´ë™)
        document.querySelectorAll(".pro_sy1, .clear").forEach(postElement => {
            postElement.addEventListener("click", function () {
                const postNumber = this.dataset.postNumber; // âœ… datasetì—ì„œ post ìˆœë²ˆ ê°€ì ¸ì˜¤ê¸°
                if (postNumber) {
                    window.location.href = `http://127.0.0.1:5500/myblog.html?n=${postNumber}`;
                }
            });
        });

    } catch (error) {
        console.error("âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜:", error);
    }
});

function createBigPost(post, index) {
    const { id, title, content, created_at, images } = post;
    
    // âœ… ëŒ€í‘œ ì´ë¯¸ì§€ ì„ íƒ (is_representativeì´ trueì¸ ì´ë¯¸ì§€)
    const representativeImage = images.find(img => img.is_representative) || images[0];
    const imageUrl = representativeImage ? representativeImage.image_url : "https://via.placeholder.com/183x185?text=No+Image";

    return `
        <div class="pro_sy1" data-post-id="${id}" data-post-number="${index}"> <!-- âœ… ê²Œì‹œë¬¼ IDì™€ ìˆœë²ˆ ì¶”ê°€ -->
            <p class="p_img">            
                <img src="${imageUrl}" width="183" height="185" alt="${title}">
            </p>
            <ul>
                <li class="p_title">${title}</li>
                <li class="p_con">${content.replace(/<\/?[^>]+(>|$)/g, "").substring(0, 50)}...</li>
                <li class="p_date">${new Date(created_at).toLocaleDateString()}</li>
            </ul>
        </div>
    `;
}

function createSmallPost(post, index) {
    const { id, title, content, created_at, images } = post;

    // âœ… ëŒ€í‘œ ì´ë¯¸ì§€ ì„ íƒ (is_representativeì´ trueì¸ ì´ë¯¸ì§€)
    const representativeImage = images.find(img => img.is_representative) || images[0];
    const imageUrl = representativeImage ? representativeImage.image_url : "https://via.placeholder.com/90x90?text=No+Image";

    return `
        <div class="clear" data-post-id="${id}" data-post-number="${index}"> <!-- âœ… ê²Œì‹œë¬¼ IDì™€ ìˆœë²ˆ ì¶”ê°€ -->
            <p class="p_img2">
                <img src="${imageUrl}" width="90" height="90" alt="${title}">
            </p>
            <ul>
                <li class="p_title">${title}</li>
                <li class="p_con">${content.replace(/<\/?[^>]+(>|$)/g, "").substring(0, 50)}...</li>
                <li class="p_date">${new Date(created_at).toLocaleDateString()}</li>
            </ul>
        </div>
    `;
}



document.addEventListener("DOMContentLoaded", async function () {
    try {
        // âœ… í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const profileResponse = await fetch("http://127.0.0.1:8000/profile/me/", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("access_token")}`,
                "Content-Type": "application/json"
            }
        });

        if (!profileResponse.ok) {
            console.error("âŒ í”„ë¡œí•„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", profileResponse.status);
            return;
        }

        const profileData = await profileResponse.json();
        const loggedInUrlname = profileData.urlname; // âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ urlname ê°€ì ¸ì˜¤ê¸°
        const username = profileData.username;

        if (!loggedInUrlname) {
            console.error("âŒ urlnameì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
            return;
        }

        // âœ… ì´ì›ƒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const neighborsResponse = await fetch(`http://127.0.0.1:8000/profile/${loggedInUrlname}/neighbors/`);
        if (!neighborsResponse.ok) {
            console.error("âŒ ì´ì›ƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", neighborsResponse.status);
            return;
        }
        const neighborsData = await neighborsResponse.json();
        const neighbors = neighborsData.neighbors;

        // âœ… ì „ì²´ ì´ì›ƒ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        const countResponse = await fetch(`http://127.0.0.1:8000/neighbors/count/${loggedInUrlname}/`);
        if (!countResponse.ok) {
            console.error("âŒ ì´ì›ƒ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", countResponse.status);
            return;
        }
        const countData = await countResponse.json();
        const neighborCount = countData.neighbor_count;

        document.getElementById("neighbor-count").innerText = neighborCount;
        document.getElementById("neighbor-new-posts").innerText = `${username}ë‹˜ ì´ì›ƒì˜ ìƒˆê¸€ ë³´ê¸° >`;

        // âœ… ì´ì›ƒ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
        const neighborContainer = document.getElementById("neighbor-container");
        const pageIndicator = document.getElementById("page-indicator");
        const prevPageBtn = document.getElementById("prev-page");
        const nextPageBtn = document.getElementById("next-page");

        let currentPage = 1;
        const itemsPerPage = 12; // âœ… í•œ í˜ì´ì§€ë‹¹ 3ëª… x 4ì¤„ = 12ëª…
        const totalPages = Math.ceil(neighbors.length / itemsPerPage);

        function renderNeighbors(page) {
            neighborContainer.innerHTML = "";
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageNeighbors = neighbors.slice(start, end);

            pageNeighbors.forEach(neighbor => {
                const { urlname, username, user_pic } = neighbor;
                const imageUrl = user_pic.startsWith("/media") ? `http://127.0.0.1:8000${user_pic}` : user_pic;

                // âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì™€ ê°™ìœ¼ë©´ `myblog.html`, ë‹¤ë¥´ë©´ `blog.html?urlname=XXX`
                const targetPage = (loggedInUrlname === urlname) ? "myblog.html" : `blog.html?urlname=${encodeURIComponent(urlname)}`;

                const neighborHtml = `
                    <div class="neighbor-item" style="text-align: center;">
                        <a href="${targetPage}">
                            <div class="neighbor-img">
                                <img src="${imageUrl}" alt="${username}" style="cursor: pointer;">
                            </div>
                        </a>
                        <a href="${targetPage}" style="text-decoration: none; color: inherit;">
                            <span class="neighbor-nickname" style="cursor: pointer;">${username}</span>
                        </a>
                    </div>
                `;
                neighborContainer.innerHTML += neighborHtml;
            });

            pageIndicator.innerText = `${currentPage} / ${totalPages}`;
        }

        prevPageBtn.addEventListener("click", () => {
            if (currentPage > 1) {
                currentPage--;
                renderNeighbors(currentPage);
            }
        });

        nextPageBtn.addEventListener("click", () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderNeighbors(currentPage);
            }
        });

        renderNeighbors(currentPage);

    } catch (error) {
        console.error("âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜:", error);
    }
});

</script>
</body>
</html>