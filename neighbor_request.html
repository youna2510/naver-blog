<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="request.css">
    <title>SG Blog</title>
    
    <script>
        function close_popup(){
          window.close();
        }
    </script>

</head>
<body>
    <!--ì´ì›ƒì¶”ê°€/ì„œì´ì¶” ì„ íƒ-->
    <div class="nr_title"><strong>ì´ì›ƒì¶”ê°€</strong></div>
    <div class="nr_ment">
        <a style="color:#da9d9c;"><strong>ì´ì›ƒ</strong></a><a>ë‹˜ì—ê²Œ ì„œë¡œì´ì›ƒì„ ì‹ ì²­í•©ë‹ˆë‹¤.</a>
        <div>
            <textarea class="writing_message" type="text" id="comment" name="comment" placeholder="ì‹ ì²­ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
        </div>
    </div>

    <div class="btns" >
        <a class="btn_cancel" onclick="close_popup()">ì·¨ì†Œ</a> <a href="./neighbor_request_fin.html" class="btn_next">ë‹¤ìŒ</a>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
    const nextButton = document.querySelector(".btn_next");
    const accessToken = localStorage.getItem("access_token");

    if (!accessToken) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.close(); // íŒì—… ë‹«ê¸°
        return;
    }

    // ğŸ”¹ URLì—ì„œ ë¸”ë¡œê·¸ ì£¼ì¸ì˜ username ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.opener.location.search);
    const toUrlname = urlParams.get("user");

    if (!toUrlname) {
        alert("ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.");
        window.close();
        return;
    }

    nextButton.addEventListener("click", async function (event) {
        event.preventDefault(); // ê¸°ë³¸ ì´ë™ ë°©ì§€

        // ğŸ”¹ ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ ì…ë ¥ë°›ê¸°
        const requestMessage = prompt("ì„œë¡œì´ì›ƒ ì‹ ì²­ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", "ì¹œí•˜ê²Œ ì§€ë‚´ê³  ì‹¶ì–´ìš”!");

        if (!requestMessage) {
            alert("ì„œë¡œì´ì›ƒ ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        try {
            // ğŸ”¹ ì„œë¡œì´ì›ƒ ì‹ ì²­ API ìš”ì²­
            const response = await fetch(`http://127.0.0.1:8000/neighbors/${encodeURIComponent(toUrlname)}/`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ request_message: requestMessage })
            });

            if (response.status === 201) {
                alert("âœ… ì„œë¡œì´ì›ƒ ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "./neighbor_request_fin.html"; // ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ì´ë™
            } else {
                const errorData = await response.json();
                alert(`âŒ ì‹ ì²­ ì‹¤íŒ¨: ${errorData.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`);
            }
        } catch (error) {
            console.error("âŒ ì„œë²„ ì˜¤ë¥˜:", error);
            alert("ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    });
});






    </script>
</body>

</html>