<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="write.css" />
    <title>SG Blog</title>

    <!-- Google Fonts ì¶”ê°€ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Noto+Serif+KR&family=Gaegu&family=Nanum+Pen+Script&family=Black+And+White+Picture&display=swap"
      rel="stylesheet"
    />
    <script>
      function popup() {
        var url = "./temp_save.html";
        var name = "temp_save";
        var option =
          "width = 480, height = 300, top = 100, left = 200, location = no";
        window.open(url, name, option);
      }
    </script>
  </head>
  <body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
      <div class="logo">SG Blog</div>
      <div class="buttons">
        <button onclick="popup()">ì„ì‹œ ì €ì¥</button>
        <button onclick="openWriteSavePopup ()">ë°œí–‰</button>
      </div>
    </div>

    <!-- ë„êµ¬ ëª¨ìŒ -->
    <div class="toolbar">
      <button onclick="openImageUploader()">ì‚¬ì§„</button>
      <input
        type="file"
        id="imageInput"
        accept="image/*"
        onchange="insertImage(event)"
      />
    </div>

    <!-- ê¸€ê¼´ ë° í¬ê¸° ì„¤ì • ë°” -->
    <div class="topbar">
      <select id="fontSelect" onchange="changeFontFamily()">
        <option value="'Nanum Gothic', sans-serif">ë‚˜ëˆ”ê³ ë”•</option>
        <option value="'Noto Serif KR', serif">Noto Serif</option>
        <option value="'Gaegu', cursive">Gaegu</option>
        <option value="'Nanum Pen Script', cursive">ë‚˜ëˆ”íœ</option>
        <option value="'Black And White Picture', cursive">
          Black & White
        </option>
      </select>

      <select id="fontSizeSelect" onchange="changeFontSize()">
        <option value="1">11</option>
        <option value="2">13</option>
        <option value="3">15</option>
        <option value="4">16</option>
        <option value="5">19</option>
        <option value="6">24</option>
        <option value="7">28</option>
        <option value="8">30</option>
        <option value="9">34</option>
        <option value="10">38</option>
      </select>

      <img
        class="lineup"
        src="assets/left.png"
        onclick="changeAlignment('left')"
      />
      <img
        class="lineup"
        src="assets/middle.png"
        onclick="changeAlignment('center')"
      />
      <img
        class="lineup"
        src="assets/right.png"
        onclick="changeAlignment('right')"
      />
      <img class="bold" src="assets/bold.png" onclick="toggleBold()" />
    </div>

    <!-- ê¸€ ì‘ì„± ì»¨í…Œì´ë„ˆ -->
    <div class="editor-container">
      <div class="editor">
        <div contenteditable="true" class="title" id="titleField">ì œëª©</div>
        <div contenteditable="true" class="content" id="contentField">
          ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...
        </div>
      </div>
    </div>

    <script>
      function changeAlignment(alignment) {
        document.execCommand("justify" + alignment);
      }

      function toggleBold() {
        document.execCommand("bold");
      }

      document.addEventListener("selectionchange", function () {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const parentNode = range.commonAncestorContainer.parentNode;

          if (parentNode) {
            const computedStyle = window.getComputedStyle(parentNode);
            document.getElementById("fontSelect").value =
              computedStyle.fontFamily;
            document.getElementById("fontSizeSelect").value =
              computedStyle.fontSize.replace("px", "");
          }
        }
      });

      //ì‚¬ì§„ì„ ë„£ì„ ìˆ˜ ìˆê²Œ í•˜ëŠ” ê¸°ëŠ¥
      function openImageUploader() {
        document.getElementById("imageInput").click();
      }

      document
        .getElementById("titleField")
        .addEventListener("focus", function () {
          if (this.textContent === "ì œëª©") {
            this.textContent = "";
            this.style.color = "black";
          }
        });

      document
        .getElementById("titleField")
        .addEventListener("blur", function () {
          if (this.textContent.trim() === "") {
            this.textContent = "ì œëª©";
            this.style.color = "#aaa";
          }
        });

      document
        .getElementById("contentField")
        .addEventListener("focus", function () {
          if (this.textContent === "ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...") {
            this.textContent = "";
            this.style.color = "black";
          }
        });

      document
        .getElementById("contentField")
        .addEventListener("blur", function () {
          if (this.textContent.trim() === "") {
            this.textContent = "ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...";
            this.style.color = "#aaa";
          }
        });

      function changeFontFamily() {
        let selectedFont = document.getElementById("fontSelect").value;
        document.execCommand("styleWithCSS", false, true); // CSS ì ìš© í™œì„±í™”
        document.execCommand("fontName", false, selectedFont);
      }

      function changeFontSize() {
        let selectedSize = document.getElementById("fontSizeSelect").value;
        document.execCommand("styleWithCSS", false, true);
        document.execCommand("fontSize", false, selectedSize); // ì„ì‹œ í¬ê¸° ì„¤ì •

        // ì„ íƒëœ í…ìŠ¤íŠ¸ì— ì ìš©ëœ font-sizeë¥¼ ë³€ê²½
        let fontElements = document.querySelectorAll("font[size='7']");
        fontElements.forEach((el) => {
          el.removeAttribute("size");
          el.style.fontSize = selectedSize + "px";
        });
      }

      document.addEventListener("selectionchange", function () {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const parentNode = range.commonAncestorContainer.parentNode;

          if (parentNode) {
            const computedStyle = window.getComputedStyle(parentNode);
            document.getElementById("fontSelect").value =
              computedStyle.fontFamily;
            document.getElementById("fontSizeSelect").value =
              computedStyle.fontSize.replace("px", "");
          }
        }
      });

      /*
              document.addEventListener("focusin", function(event) {
          if (event.target.classList.contains("image-caption")) {
              if (event.target.textContent.trim() === "ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...") {
                  event.target.textContent = ""; // âœ… í´ë¦­ ì‹œ ë¹ˆ ê³µê°„ìœ¼ë¡œ ë³€ê²½
                  event.target.style.color = "black";
              }
          }
      });*/
      /*
      document.addEventListener("focusout", function(event) {
          if (event.target.classList.contains("image-caption")) {
              if (event.target.textContent.trim() === "") {
                  event.target.textContent = "ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...";
                  event.target.style.color = "gray";
              }
          }
      });*/

      document.addEventListener("DOMContentLoaded", function () {
        let selectedImage = null; // í˜„ì¬ ì„ íƒëœ ëŒ€í‘œì‚¬ì§„

        function insertImage(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            const figure = document.createElement("figure");
            figure.style.textAlign = "center";
            figure.style.margin = "15px 0";
            figure.style.position = "relative"; // ë²„íŠ¼ì„ ìœ„í•œ position ì„¤ì •

            const img = document.createElement("img");
            img.src = e.target.result;
            img.style.maxWidth = "300px";
            img.style.height = "auto";
            img.style.marginTop = "10px";
            img.style.borderRadius = "5px";
            img.style.cursor = "pointer";
            img.classList.add("editable-image"); // ì´ë¯¸ì§€ì— í´ë˜ìŠ¤ ì¶”ê°€

            const caption = document.createElement("figcaption");
            caption.contentEditable = "false";
            caption.classList.add("image-caption");
            caption.style.fontSize = "14px";
            caption.style.marginTop = "5px";
            caption.style.cursor = "text";
            caption.style.color = "gray";
            caption.innerHTML =
              "<input type = text id = 'caption_input' placeholder = " +
              "'ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...'" +
              ">";
            caption.style.display = "none";

            const selectButton = document.createElement("button");
            selectButton.contentEditable = "false";
            selectButton.innerText = "ëŒ€í‘œì‚¬ì§„ ì„ íƒ";
            selectButton.style.position = "absolute";
            selectButton.style.bottom = "30px";
            selectButton.style.left = "50%";
            selectButton.style.transform = "translateX(-50%)";
            selectButton.style.padding = "5px 10px";
            selectButton.style.fontSize = "12px";
            selectButton.style.border = "none";
            selectButton.style.borderRadius = "5px";
            selectButton.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
            selectButton.style.color = "white";
            selectButton.style.cursor = "pointer";
            selectButton.style.display = "none"; // ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€
            selectButton.style.userSelect = "none";

            // ì´ë¯¸ì§€ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë²„íŠ¼ í‘œì‹œ
            figure.addEventListener("mouseenter", function () {
              selectButton.style.display = "block";
              caption.style.display = "block";
            });

            // ì´ë¯¸ì§€ì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚˜ë©´ ë²„íŠ¼ ìˆ¨ê¹€
            figure.addEventListener("mouseleave", function () {
              selectButton.style.display = "none";
              let cap_input = document.getElementById("caption_input");
              if (cap_input.value == "") {
                caption.style.display = "none";
              } else {
                caption.style.display = "display";
              }
            });

            // ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ€í‘œì‚¬ì§„ìœ¼ë¡œ ì„ íƒ
            selectButton.addEventListener("click", function (event) {
              event.stopPropagation(); // ë¶€ëª¨ figureì˜ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

              if (selectedImage) {
                selectedImage.style.outline = "none"; // ì´ì „ ëŒ€í‘œì‚¬ì§„ í…Œë‘ë¦¬ ì œê±°
              }

              selectedImage = img;
              img.style.outline = "4px solid #861f1c"; // ëŒ€í‘œì‚¬ì§„ ìœ¤ê³½ì„  í‘œì‹œ
            });

            figure.appendChild(img);
            figure.appendChild(selectButton);
            figure.appendChild(caption);

            insertAtCursor(figure);
          };
          reader.readAsDataURL(file);
        }

        function insertAtCursor(element) {
          const contentField = document.getElementById("contentField");
          contentField.focus();

          const selection = window.getSelection();
          if (!selection.rangeCount) {
            contentField.appendChild(element);
            return;
          }

          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(element);

          range.setStartAfter(element);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        }

        document
          .getElementById("imageInput")
          .addEventListener("change", insertImage);
      });

      // ===========================
      // âœ… 1ï¸âƒ£ ì œëª©Â·ë³¸ë¬¸ ìˆ˜ì§‘ (collectPostData)
      // ===========================
      function collectPostData() {
        const title = document.getElementById("titleField").innerHTML.trim();
        const content = document
          .getElementById("contentField")
          .innerHTML.trim();

        if (!title || title === "ì œëª©") {
          alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }
        if (!content || content === "ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...") {
          alert("ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }

        // ğŸ”¥ ë³¸ë¬¸(content)ì— HTML ë° CSS í¬í•¨
        window.postData = {
          title: title,
          content: content,
        };

        return true;
      }

      // ===========================
      // âœ… 2ï¸âƒ£ ìì‹ ì°½ ê°ì²´ ì „ì—­ ì„ ì–¸ (ReferenceError í•´ê²°)
      // ===========================
      let childWindow = null;

      // ===========================
      // âœ… 3ï¸âƒ£ ë¶€ëª¨-ìì‹ ê°„ postMessage ë¦¬ìŠ¤ë„ˆ (ì „ì—­ì— ì‘ì„±)
      // ===========================
      window.addEventListener("message", (event) => {
        if (event.data === "CHILD_READY" && childWindow) {
          // âœ… ìì‹ ì°½ì´ ì¤€ë¹„ë˜ë©´ postData ì „ë‹¬
          childWindow.postMessage(
            { type: "POST_DATA", payload: window.postData },
            "*"
          );
          console.log(
            "ğŸš€ [ë¶€ëª¨ ì°½] postDataë¥¼ ìì‹ ì°½ì— ì „ë‹¬:",
            window.postData
          );
        }
      });

      // ===========================
      // âœ… 4ï¸âƒ£ ë°œí–‰ íŒì—… ì—´ê¸°: openWriteSavePopup
      // ===========================
      function openWriteSavePopup() {
        // ğŸŸ¡ ì œëª©Â·ë³¸ë¬¸ ìˆ˜ì§‘ í›„ ì‹¤í–‰
        if (!collectPostData()) {
          return;
        }

        // âœ… ìì‹ ì°½ ì—´ê¸°
        childWindow = window.open(
          "write_save.html",
          "WriteSavePopup",
          "width=600,height=700"
        );

        // ğŸŸ¡ ìì‹ ì°½ì´ `postMessage` ì‹ í˜¸ ë³´ë‚¼ ë•Œê¹Œì§€ ëŒ€ê¸°
        if (!childWindow) {
          console.error("ğŸš¨ ìì‹ ì°½ ì—´ê¸° ì‹¤íŒ¨");
          alert("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
      }

      // ===========================
      // âœ… 5ï¸âƒ£ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°
      // ===========================
    </script>
  </body>
</html>
